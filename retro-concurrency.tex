\documentclass[sigplan,10pt,review,anonymous]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}

%% Some recommended packages.
\usepackage{booktabs}   %% For formal tables:
                        %% http://ctan.org/pkg/booktabs
\usepackage{subcaption} %% For complex figures with subfigures/subcaptions
                        %% http://ctan.org/pkg/subcaption


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Custom definitions
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{balance}
\usepackage{url}
\usepackage{enumitem}
\usepackage{hyperref}
\usepackage{listings}
\usepackage{xspace}
\usepackage{cleveref}
\usepackage{multirow}
\usepackage{microtype}
\usepackage{soul,xcolor}
\usepackage{mathpartir}
\usepackage{amsmath,amsthm}
\usepackage[utf8]{inputenc}
\input{unicode-preamble.tex}
\usepackage{mathtools}
\usepackage{tikz}
\usetikzlibrary{calc,decorations.pathmorphing,shapes}
\usepackage{stmaryrd}

\crefformat{section}{§#2#1#3}
\newtheorem{theorem}{Theorem}
\newtheorem{definition}[theorem]{Definition}

\newenvironment{nop}{}{}
\newenvironment{smathpar}{
\begin{nop}\small\begin{mathpar}}{
\end{mathpar}\end{nop}\ignorespacesafterend}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Semantics definitions
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\newcommand{\olam}[2]{\lambda #1. #2}
\newcommand{\llambda}{\lambda\!\!\lambda}
\newcommand{\clam}[2]{\llambda #1. #2}
\newcommand{\lam}[2]{\Lambda #1. #2}

\newcommand{\env}{\epsilon}
\newcommand{\envext}[3]{#1[#2 \mapsto #3]}

\newcommand{\oclos}[3]{\llparenthesis \olam{#1}{#2}, #3 \rrparenthesis}
\newcommand{\cclos}[3]{\llparenthesis \clam{#1}{#2}, #3 \rrparenthesis}
\newcommand{\clos}[3]{\llparenthesis \lam{#1}{#2}, #3 \rrparenthesis}
\newcommand{\kw}[1]{\text{\bf #1}}
\newcommand{\effval}[2]{\textsf{do} ~#1 ~#2}
\newcommand{\exnval}[1]{\textsf{exn} ~#1}

\newcommand{\handle}[2]{\kw{handle} ~#1 ~\kw{with} ~#2}
\newcommand{\throw}[2]{\kw{raise} ~#1 ~#2}
\newcommand{\perform}[2]{\kw{perform} ~#1 ~#2}

\newcommand{\caseval}[2]{\kw{return}~#1 \mapsto #2}
\newcommand{\caseexn}[3]{#1 ~#2 \mapsto #3}
\newcommand{\caseeff}[4]{#1 ~#2 ~#3 \mapsto #4}

\newcommand{\farg}[2]{\langle #1 ~#2 \rangle_a}
\newcommand{\ffun}[1]{\langle #1 \rangle_f}
\newcommand{\faritha}[3]{\langle #1 ~#2 ~#3 \rangle_{b1}}
\newcommand{\farithb}[2]{\langle #1 ~#2 \rangle_{b2}}

\newcommand{\kcons}{\lhd}
\newcommand{\fiber}{\varphi}
\newcommand{\fl}{\psi} % Frame List
\newcommand{\hc}{\eta} % Handler Closure

\newcommand{\cstack}{\gamma} % C Stack
\newcommand{\ostack}{\omega} % OCaml Stack
\newcommand{\cstacka}[2]{\big \lceil #1, #2 \big \rceil_c} % C stack with arguments
\newcommand{\ostacka}[2]{\big \lceil #1, #2 \big \rceil_o} % OCaml stack with arguments
\newcommand{\ostackemp}{\bullet}
\newcommand{\stack}{\sigma}

\newcommand{\term}{\tau}
\newcommand{\config}{\mathfrak{C}}
\newcommand{\configa}[3]{\|#1,#2,#3\|}

\newcommand{\ostep}{\xrightarrow{o}}
\newcommand{\cstep}{\xrightarrow{c}}

\begin{document}

\title{Retrofitting Concurrency onto OCaml}

\begin{abstract}
  A clear and well-documented \LaTeX\ document is presented as an
  article formatted for publication by ACM in a conference proceedings
  or journal publication. Based on the ``acmart'' document class, this
  article presents and explains many of the common variations, as well
  as many of the formatting elements an author may use in the
  preparation of the documentation of their work.
\end{abstract}

\maketitle

\section{Introduction}

\bibliographystyle{ACM-Reference-Format}
\bibliography{sample-base}

\section{Semantics}

\begin{figure*}
	\begin{minipage}[t]{0.49\linewidth}
	\begin{mathpar}
	\begin{array}{rrcl}
		\text{Constants} & n & \coloneqq & ℕ \\
		\text{Abstractions} & \Lambda & \coloneqq & \lambda \mid \llambda \\
		\text{Expressions} & e & \coloneqq & n \mid x \mid e ~e \mid  \lam{x}{e} \mid e \odot e \mid \throw{l}{e} \\
											 &   & \mid      & \handle{e}{h} \mid \perform{l}{e} \\
		\text{Handlers} & h & \coloneqq & \{\caseval{x}{e}\} \mid \{\caseexn{l}{x}{e}\} \uplus h \\
		               &   & \mid & \{\caseeff{l}{x}{k}{e}\} \uplus h \\
		\text{Values} & v & \coloneqq & n \mid k \mid \clos{x}{e}{\env} \mid \effval{l}{k} \mid \exnval{l} \\
		\text{Frames} & r & \coloneqq & \farg{e}{\env} \mid \ffun{v} \mid \faritha{\odot}{e}{\env} \mid \farithb{\odot}{ℕ} \\
		\text{Environments} & \env & \coloneqq & \emptyset \mid \envext{\env}{x}{v} \\
	\end{array}
	\end{mathpar}
	\end{minipage}
	\begin{minipage}[t]{0.49\linewidth}
	\begin{mathpar}
	\begin{array}{rrcl}
		\text{Handler Closures} & \hc & \coloneqq & (h,\env) \\
		\text{Frame List} & \fl & \coloneqq & [] \mid r :: \fl \\
		\text{Fibers} & \fiber & \coloneqq & (\fl, \hc) \\
		\text{Continuations} & k & \coloneqq & [] \mid \fiber \lhd k \\
		\text{C stacks} & \cstack & \coloneqq & \cstacka{\fl}{\ostack}\\
		\text{OCaml stacks} & \ostack & \coloneqq & \ostacka{k}{\cstack} \mid \ostackemp \\
		\text{Stacks} & \stack & \coloneqq & \cstack \mid \ostack \\
		\text{Terms} & \term & \coloneqq & e \mid v \\
		\text{Configurations} & \config & \coloneqq & \configa{\tau}{\env}{\stack}
	\end{array}
	\end{mathpar}
	\end{minipage}
	\caption{Term Syntax}
	\label{sem:syntax}
\end{figure*}

\begin{figure*}
	\begin{smathpar}
		\begin{array}{rrcl}
			\textsc{Var}     & (x,\env, \fl) & \rightsquigarrow
			                 & (\env(x), \env, \fl) \\
			\textsc{Arith1}  & (e_1 \odot e_2, \env, \fl) & \rightsquigarrow
			                 & (e_1,\env, \faritha{\odot}{e_2}{\env}::\fl) \\
			\textsc{Arith2}  & (n_1, \_, \faritha{\odot}{e_2}{\env}::\fl) & \rightsquigarrow
			                 & (e_2, \env, \farithb{\odot}{n_1}::\fl) \\
			\textsc{Arith3}  & (n_2, \env, \farithb{\odot}{n_1}::\fl) & \rightsquigarrow
			                 & (\llbracket n_1 \odot n_2 \rrbracket, \env, \fl) \\
			\textsc{App1}    & (e_1 ~e_2, \env, \fl) & \rightsquigarrow
			                 & (e_1, \env, \farg{e_2}{\env}::\fl) \\
			\textsc{App2}    & (\lam{x}{e}, \env, \fl) & \rightsquigarrow
			                 & (\clos{x}{e}{\env}, \env, \fl) \\
			\textsc{App3}    & (\clos{x}{e_1}{\env_1}, \_, \farg{e_2}{\env_2}::\fl) & \rightsquigarrow
			                 & (e_2, \env_2, \ffun{\clos{x}{e_1}{\env_1}}::\fl) \\
			\textsc{Resume1} & (k,\_,\farg{e_1}{\env_1}::\farg{e_2}{\env_2}::\fl) & \rightsquigarrow
			                 & (e_1, \env_1, \ffun{k}::\farg{e_2}{\env_2}::\fl) \\
			\textsc{Resume2} & (\clos{x}{e_1}{\env_1}, \_, \ffun{k}::\farg{e_2}{\env_2}::\fl) & \rightsquigarrow
			                 & (e_2, \env_2, \ffun{k}::\ffun{\clos{x}{e_1}{\env_1}}::\fl) \\
			\textsc{Perform} & (\perform{l}{e}, \env, \fl) & \rightsquigarrow
			                 & (e, \env, \ffun{\effval{l}{[[],(\{\caseval{x}{x}\},\emptyset)]}}::\fl) \\
			\textsc{Raise}   & (\throw{l}{e}, \env, \fl) & \rightsquigarrow
											 & (e, \env, \ffun{\exnval{l}}::\fl)
		\end{array}
	\end{smathpar}
	\caption{Local Reductions -- $(\term, \env, \fl) \rightsquigarrow (\tau, \fl)$.}
	\label{sem:step}
\end{figure*}

\begin{figure*}
	\begin{smathpar}
		\begin{array}{rrcll}
			\textsc{LocalO}   & (\term,\env,(\fl,\hc) \kcons k,\cstack) & \ostep
												& \configa{\term'}{\env'}{\ostacka{(\fl',\hc) \kcons k}{\cstack}}
												& \text{if } (\term,\env,\fl) \rightsquigarrow (\term',\env',\fl') \\
			\textsc{RetToC}   & (v, \env, [([],\hc)], \cstack) & \ostep
												& \configa{v}{\env}{\cstack}  \\
			\textsc{RetFiber} & (v, \_, ([],(h,\env)) \kcons k, \cstack) & \ostep
												& \configa{e}{\envext{\env}{x}{v}}{\ostacka{k}{\cstack}}
												& \text{if } \{\caseval{x}{e}\} \in h \\
			\textsc{CallO}    & (v, \_, (\oclos{x}{e}{\env}::\fl,\hc) \kcons k, \cstack) & \ostep
												& \configa{e}{\envext{\env}{x}{v}}{\ostacka{(\fl,\hc) \kcons k}{\cstack}} \\
			\textsc{ExtCall}  & (v, \_, (\cclos{x}{e}{\env}::\fl,\hc) \kcons k, \cstack) & \ostep
												& \configa{e}{\envext{\env}{x}{v}}{\cstacka{[]}{\ostacka{(\fl,\hc) \kcons k}{\cstack}}} \\
			\textsc{Resume}   & (v, \_, (\ffun{k}::\ffun{\oclos{x}{e}{\env}}::\fl,\hc) \kcons k, \cstack) & \ostep
												& \configa{e}{\envext{\env}{x}{v}}{\ostacka{k ~@~ (\fl,\hc) \kcons k'}{\cstack}} \\
			\textsc{Handle}   & (\handle{e}{h}, \env, k, \cstack) & \ostep
												& \configa{e}{\env}{\ostacka{([],(h,\env)) \kcons k}{\cstack}} \\
			\textsc{EffUnHn}  & (v, \_, [\ffun{\effval{l}{k}}::\fl,(h,\env)], \cstack) & \ostep
												& \configa{\throw{\textsf{unhandled}}{0}}{\emptyset}{\ostacka{k ~@~ [(\fl,(h,\env))]}{\cstack}}
												& \text{if } \{\caseeff{l}{\_}{\_}{\_}\} \notin h \\
			\textsc{EffHn}    & (v, \_, (\ffun{\effval{l}{k}}::\fl,(h,\env)) \kcons k', \cstack) & \ostep
												& \configa{e}{\env[r \mapsto k''][x \mapsto v]}{\ostacka{k'}{\cstack}}
												& \text{if } \{\caseeff{l}{x}{r}{e}\} \in h \\
									& & & & \text{and } k'' = k ~@~ [(\fl,(h,\env))] \\
			\textsc{EffFwd}   & (v, \env', (\ffun{\effval{l}{k}}::\fl,(h,\env)) \kcons (\fl',\hc') \kcons k', \cstack) & \ostep
												& \configa{v}{\env'}{\ostacka{(\ffun{\effval{l}{k''}}::\fl',\hc') \kcons k'}{\cstack}}
												& \text{if } \{\caseeff{l}{\_}{\_}{\_}\} \notin h \\
								  & & & & \text{and } k'' = k ~@~ [(\fl,(h,\env))] \\
			\textsc{ExUnHn}  & (v, \env, [\ffun{\exnval{l}}::\_,(h,\_)], \cstacka{\fl'}{\ostack}) & \ostep
												& \configa{v}{\env}{\cstacka{\ffun{\exnval{l}}::\fl'}{\ostack}}
												& \text{if } \{\caseexn{l}{\_}{\_}\} \notin h \\
			\textsc{ExHn}     & (v, \_, (\ffun{\exnval{l}}::\_,(h,\env)) \kcons k', \cstack) & \ostep
												& \configa{e}{\envext{\env}{x}{v}}{\ostacka{k'}{\cstack}}
												& \text{if } \{\caseexn{l}{x}{e}\} \in h \\
			\textsc{ExFwd}    & (v, \env, (\ffun{\exnval{l}}::\_,(h,\_)) \kcons (\fl',\hc') \kcons k', \cstack) & \ostep
												& \configa{v}{\env}{\ostacka{(\ffun{\exnval{l}}::\fl',\hc') \kcons k'}{\cstack}}
												& \text{if } \{\caseexn{l}{\_}{\_}\} \notin h \\
		\end{array}
	\end{smathpar}
	\caption{OCaml Reductions -- $(\term, \env, k, \cstack) \xrightarrow{o} \config$.}
	\label{sem:ostep}
\end{figure*}

\begin{figure*}
	\begin{smathpar}
		\begin{array}{rrcll}
			\textsc{LocalC}   & (\term,\env,\fl,\ostack) & \cstep
												& \configa{\term'}{\env'}{\cstacka{\fl'}{\ostack}}
												& \text{if } (\term,\env,\fl) \rightsquigarrow (\term',\env',\fl') \\
			\textsc{RetToO}   & (v,\env,[],\ostacka{k}{\cstack}) & \cstep
			                  & \configa{v}{\env}{\ostacka{k}{\cstack}} \\
			\textsc{CallC}    & (v, \_, \cclos{x}{e}{\env}::\fl, \ostack) & \ostep
												& \configa{e}{\envext{\env}{x}{v}}{\cstacka{\fl}{\ostack}} \\
			\textsc{Callback} & (v, \_, \oclos{x}{e}{\env}::\fl, \ostack) & \ostep
		\end{array}
	\end{smathpar}
	\caption{C Reductions -- $(\term, \env, \fl, \ostack) \cstep \config$.}
	\label{sem:cstep}
\end{figure*}
\end{document}
